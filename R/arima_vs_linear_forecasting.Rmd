---
title: "A Forecasting Model Comparison"
author: "VickyBanks"
date: "`r Sys.Date()`"
output: html_document
toc: true
toc_float: true
ceruleancss: picture.css
---
# {.tabset .tabset-fade}
<style>
.main-container {
    max-width: 940px;
    margin-left: auto;
    margin-right: auto;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.width=7, fig.height=5)
knitr::knit_hooks$get("source")
knitr::knit_hooks$get("output")
invisible(gc())
library(tidyverse)
library(dbplyr)
library(knitr)
library(ggplot2)
library(lubridate)
library(scales)
library(kableExtra)
library(zoo)

theme_set(theme_classic())


```



```{r read_in_data, echo = FALSE}

### covid factor
covid_factor<- read.csv("~/Documents/Projects/DS/vb_nations_2030_forecast/data/Covid trend data.csv")
covid_factor$week_commencing<-dmy(covid_factor$date)

covid_factor<-
  covid_factor %>% select(week_commencing, x_google_mob_retail) %>%
  rename(covid = x_google_mob_retail)

#covid_factor %>% head()

## dates
dates <- data.frame(week_commencing = seq(
  as.Date('2014-12-29' %>% ymd() + 7),
  by = "week",
  length.out = 52 * 8
)) %>%
  mutate(year = year(week_commencing),
         quarter = quarter(week_commencing),
         week = week(week_commencing)
         ) %>%
  filter(paste0(year,quarter) < '20203')

new_year <-
  dates %>%
  filter(week == 1) %>%
  select(week_commencing, year,quarter) %>%
  mutate(year_quarter = paste0(year,'-q',quarter))



## read in tv and radio data
radio<-read.csv('~/Documents/Projects/DS/vb_nations_2030_forecast/data/england_rajar_bbc.csv')
tv <-
  read.csv('~/Documents/Projects/DS/vb_nations_2030_forecast/data/england_tv.csv') %>% mutate(year_quarter = paste0(year, '_q', quarter))

tv$week_commencing<- ymd(tv$week_commencing)
tv$week = week(tv$week_commencing)

##clean
radio <- radio %>% mutate(region = 'England') %>%
  select(region, year, quarter, year_quarter, reach000s,hours000s, covid) %>%
  filter(year<=2020) %>%
  filter(!is.na(reach000s )) %>%
  right_join(dates, by = c('year', 'quarter') )
#radio %>% head()


##clean
tv <-
  tv %>% select(region, year, quarter, year_quarter, week, week_commencing, viewers) %>%
  left_join(covid_factor, by = 'week_commencing') %>%
  replace(is.na(.), 0) 

#tv %>% head()

```

<!-- ## Local BBC Radio England -->

<!-- ### RAJAR Data for Local England Radio  -->

<!-- The quarterly listening hours to BBC local radio stations in England from 2015 until Q1 2020, before recording data stopped because of Covid. -->

<!-- Visually the radio data suggest some cyclical behaviour with a higher number of hours in the winter quarters.  -->
<!-- <br> -->


<!-- ```{r radio, echo=FALSE} -->
<!-- x_dates <- -->
<!--   radio %>% group_by(year) %>% filter(quarter == 1) %>% select(week_commencing) %>% filter(week_commencing == min(week_commencing)) %>% ungroup() %>% mutate(year = year(week_commencing)) -->


<!-- ### radio Graph -->
<!-- ggplot(data = radio, -->
<!--        aes(x = week_commencing, y = hours000s))+ -->
<!--   geom_point(colour = 'red')+ -->
<!--   scale_y_continuous( -->
<!--     label = comma, -->
<!--     limits = ~ c(0, max(.x) * 1.1), -->
<!--     n.breaks = 10 -->
<!--   )+ -->
<!--   theme( -->
<!--     axis.text.x = element_text(angle = 90), -->
<!--     panel.grid.major.y = element_line(size = .1, color = "grey") , -->
<!--     panel.grid.major.x = element_blank(), -->
<!--     panel.grid.minor.x = element_blank(), -->
<!--     panel.grid.minor.y = element_blank(), -->
<!--     legend.title=element_blank(), -->
<!--     legend.position="none" -->
<!--   ) + -->
<!--   labs(title = "RAJAR England local radio listeners") + -->
<!--   xlab("year")+ -->
<!--   geom_vline( -->
<!--     xintercept = new_year$week_commencing, -->
<!--     linetype = "dashed", -->
<!--     color = "grey" -->
<!--   )+ -->
<!--   scale_x_date( -->
<!--     limits = as.Date(c(radio$week_commencing %>% min(),radio$week_commencing %>% max() )), -->
<!--     labels = date_format("%Y-%m-%d"), -->
<!--     breaks = x_dates$week_commencing, -->
<!--     sec.axis = sec_axis( -->
<!--       name = NULL, -->
<!--       trans = ~ ., -->
<!--       labels = function(x) format(as.yearqtr(x), "%Y") -->
<!--     ) -->
<!--   ) -->

<!-- # ### radio Graph -->
<!-- ggplot(data = radio, -->
<!--        aes(x = week_commencing, y = reach000s))+ -->
<!--   geom_point(colour = 'blue')+ -->
<!--   scale_y_continuous( -->
<!--     label = comma, -->
<!--     limits = ~ c(0, max(.x) * 1.1), -->
<!--     n.breaks = 10 -->
<!--   )+ -->
<!--   theme( -->
<!--     axis.text.x = element_text(angle = 90), -->
<!--     panel.grid.major.y = element_line(size = .1, color = "grey") , -->
<!--     panel.grid.major.x = element_blank(), -->
<!--     panel.grid.minor.x = element_blank(), -->
<!--     panel.grid.minor.y = element_blank(), -->
<!--     legend.title=element_blank(), -->
<!--     legend.position="none" -->
<!--   ) + -->
<!--   labs(title = "RAJAR England local radio listeners") + -->
<!--   xlab("year")+ -->
<!--   geom_vline( -->
<!--     xintercept = new_year$week_commencing, -->
<!--     linetype = "dashed", -->
<!--     color = "grey" -->
<!--   )+ -->
<!--   scale_x_date( -->
<!--     limits = as.Date(c(radio$week_commencing %>% min(),radio$week_commencing %>% max() )), -->
<!--     labels = date_format("%Y-%m-%d"), -->
<!--     breaks = x_dates$week_commencing, -->
<!--     sec.axis = sec_axis( -->
<!--       name = NULL, -->
<!--       trans = ~ ., -->
<!--       labels = function(x) format(as.yearqtr(x), "%Y") -->
<!--     ) -->
<!--   ) -->


<!-- radio %>% -->
<!--   select(year, quarter, reach000s, hours000s) %>% -->
<!--   unique() %>% -->
<!--   mutate(reach000s = comma(signif(reach000s,2)), -->
<!--          hours000s = comma(signif(hours000s,2))) %>% -->
<!--   kbl(booktabs = T, caption = "RAJAR England local radio listeners", -->
<!--       col.names = c("year", "quarter", "reach000s", "hours000s"), -->
<!--     escape = F) %>% -->
<!--   kable_styling(bootstrap_options =c("striped", "scale_down","hover")) -->

<!-- ``` -->

<!-- <br> <br> -->


## Local BBC TV

### Local TV News Endland

The BARB viewing figures for the local news 6:30 bulletin for BBC England from 2017. 

<br>

```{r tv, echo=FALSE}
x_dates <-
  tv %>% group_by(year) %>% filter(quarter == 1) %>% select(week_commencing) %>% filter(week_commencing == min(week_commencing)) %>% ungroup() %>% mutate(year = year(week_commencing))

new_year<- tv %>% group_by(year) %>% filter(week_commencing == min(week_commencing)) %>% select(week_commencing, year, quarter, year_quarter)

### radio Graph
ggplot(data = tv,
       aes(x = week_commencing, y = viewers))+
  geom_point(colour = 'red')+
  scale_y_continuous(
    label = comma,
    limits = ~ c(0, max(.x) * 1.1),
    n.breaks = 10
  )+
  theme(
    axis.text.x = element_text(angle = 90),
    panel.grid.major.y = element_line(size = .1, color = "grey") ,
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.title=element_blank(),
    legend.position="none"
  ) +
  labs(title = "BARB England local News Viewers") +
  xlab("year")+
  geom_vline(
    xintercept = new_year$week_commencing,
    linetype = "dashed",
    color = "grey"
  )+
  scale_x_date(
    limits = as.Date(c(tv$week_commencing %>% min(),tv$week_commencing %>% max() )),
    labels = date_format("%Y-%m-%d"),
    breaks = x_dates$week_commencing,
    sec.axis = sec_axis(
      name = NULL,
      trans = ~ .,
      labels = function(x) format(as.yearqtr(x), "%Y")
    )
  )
```

<br>
<br>
<br>


```{r tv_table_summary }


tv %>%
  select(year, week_commencing, viewers) %>%
  group_by(year) %>%
  summarise(viewers= mean(viewers)) %>%
  mutate(viewers = comma(signif(viewers,2))) %>%
  kbl(booktabs = T, caption = "BARB England local News Viewers",
      col.names = c("year", "average weekly viewers"),
      align = 'r',
    escape = F) %>%
  kable_styling(bootstrap_options =c("striped", "scale_down","hover"))


```
<br>
<br>


```{r tv_table}

tv %>%
  select(year, week_commencing, viewers) %>%
  unique() %>%
  mutate(viewers = comma(signif(viewers, 2))) %>%
  kbl(
    booktabs = T,
    caption = "BARB England local News Viewers",
    col.names = c("year", "week_commencing", "viewers"),
    align = "rrr",
    escape = F
  ) %>%
  kable_styling(bootstrap_options = c("striped", "scale_down", "hover")) %>%
  scroll_box(height = "800px")

```

<br>
<br>
<br>
<br>




## Linear Model

#### Overview

A linear model is the simplest method to forecast. The best fit for a linear trend line is created from the historical data and projected onto future dates. The linear model, at it's most basic, is nothing more than a line of best fit.

From the graph showing TV viewing, a few trends can be observed.

1. A general decline in viewing over time.
2. A seasonal trend with higher viewing in the winter months and lower viewing in the summer.
3. A significant boost throughout the Covid period from early 2020 until early 2021.

<br>
<br>

```{r tv_graph, echo=FALSE}

x_dates <-
tv %>% select(year, quarter, year_quarter, week_commencing, week) %>%
  rbind(
    data.frame(week_commencing = seq(
      as.Date(tv$week_commencing %>% max() %>% ymd() + 7),
      by = "week",
      length.out = 52 * 9
    )) %>%
      mutate(
        year = year(week_commencing),
        quarter = quarter(week_commencing),
        year_quarter = paste0(year, "_q", quarter),
        week = week(week_commencing)
      ) %>%
      filter(year < 2031) %>%
      select(year, quarter, year_quarter, week_commencing, week)
  ) %>% unique()

x_axis_qtr_dates<- x_dates %>%
  group_by(year, quarter, year_quarter) %>% summarise(week_commencing = min(week_commencing))

new_year <-
  x_dates %>% group_by(year) %>%
  filter(week_commencing == min(week_commencing)) %>%
  select(week_commencing, year, quarter, year_quarter)



### tv Graph
tv_graph<-
  ggplot(data = tv,
       aes(x = week_commencing, y = viewers))+
  geom_point(colour = 'red')+
  scale_y_continuous(
    label = comma,
    limits = ~ c(0, max(.x) * 1.1),
    n.breaks = 10
  )+
  theme(
    axis.text.x = element_text(angle = 90),
    panel.grid.major.y = element_line(size = .1, color = "grey") ,
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.title=element_blank(),
    legend.position="none"
  ) +
  labs(title = "BARB England local News Viewers") +
  xlab("year")+
  geom_vline(
    xintercept = new_year$week_commencing[new_year$week_commencing <= max(tv$week_commencing) ] ,
    linetype = "dashed",
    color = "grey"
  )+
  scale_x_date(
    limits = as.Date(
      c(
        x_axis_qtr_dates$week_commencing[x_axis_qtr_dates$week_commencing <= max(tv$week_commencing)] %>% min(),
        x_axis_qtr_dates$week_commencing[x_axis_qtr_dates$week_commencing <= max(tv$week_commencing)] %>% max()
      )
    ),
    labels =  function(x)
      format(as.yearqtr(x), "%Y Q%q'"),
    breaks = x_axis_qtr_dates$week_commencing[x_axis_qtr_dates$quarter == 1 & 
                                       x_axis_qtr_dates$week_commencing <= max(tv$week_commencing)] ,
sec.axis = sec_axis(
  name = NULL,
  trans = ~ .,
  labels = function(x)
    format(as.yearqtr(x), "%Y")
)
  )
tv_graph
```

### Simple trend 

<br>
Adding a simple linear trend to the graph produces the forecast shown below in black where a downwards trend is given. This trend has no seasonality and looks to be inflated by the higher than typical viewing during Covid. A blue trend line was also added which uses historic data from pre-Covid and shows a much steeper downwards trend. 

<br>


```{r tv_simple_forecast, echo=FALSE}


### tv Graph
tv_basic_graph <-
  ggplot(data = tv,
       aes(x = week_commencing, y = viewers))+
  geom_point(colour = 'red')+
  scale_y_continuous(
    label = comma,
    limits = ~ c(0, max(.x) * 1.1),
    n.breaks = 10
  )+
  theme(
    axis.text.x = element_text(angle = 90),
    panel.grid.major.y = element_line(size = .1, color = "grey") ,
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.title=element_blank(),
    legend.position="none"
  ) +
  labs(title = "BARB England local News Viewers") +
  xlab("year")+
  geom_vline(
    xintercept = new_year$week_commencing ,
    linetype = "dashed",
    color = "grey"
  )+
  scale_x_date(
    limits = as.Date(
      c(
        x_axis_qtr_dates$week_commencing%>% min(),
        x_axis_qtr_dates$week_commencing%>% max()
      )
    ),
    labels =  function(x)
      format(as.yearqtr(x), "%Y Q%q'"),
    breaks = x_axis_qtr_dates$week_commencing[x_axis_qtr_dates$quarter == 1 ] ,
sec.axis = sec_axis(
  name = NULL,
  trans = ~ .,
  labels = function(x)
    format(as.yearqtr(x), "%Y")
)
  )

tv_basic_graph +
  geom_smooth(
    method = "lm",
    colour = "black",
    linetype = "dashed",
    fullrange = TRUE,
    se = FALSE
  ) +
  geom_smooth(
    data = tv %>% filter(year < 2020),
    method = "lm",
    colour = "blue",
    linetype = "dashed",
    fullrange = TRUE,
    se = FALSE
  )

```

<br>

The linear model so far is of the form `y ~ x` where y is the number of viewers and x is the week commencing. However the trends identified visually are not dependent on the factor 'week commencing' itself.

1. The downwards trend is linked to the year of viewing.
2. The seasonal viewing is linked to the quarter as there is lower viewing in the summer quarter and higher in the winter quarters.
<br>

Plotted on the graph are the linear models giving:

* `viewers ~ year` in red, 
* `viewers ~ quarter` in green
* `viewers ~ week` in purple



Using just the year gives the gradual decline over all we would expect, whilst using just the quarter or just the week shows a seasonal variation. However, the seasonal trend identifiable shows lower viewing in the summer months and higher viewing in the winter, but both the quarter and week linear model show the highest point at new year and a gradual decline throughout the year which is not correct. 


```{r tv_make_trends, echo=FALSE}

model_year <- lm(data = tv   , formula = viewers ~ year)
future_dates<- x_dates %>% filter(week_commencing > max(tv$week_commencing))
forecast_year <-
  cbind(future_dates) %>%
  data.frame(viewers =  predict(model_year, future_dates)) 


model_qtr <- lm(data = tv, formula = viewers ~ quarter)
future_dates<- x_dates %>% filter(week_commencing > max(tv$week_commencing))
forecast_qtr <-
  cbind(future_dates) %>%
  data.frame(viewers =  predict(model_qtr, future_dates))


model_week <- lm(data = tv, formula = viewers ~ week)
future_dates<- x_dates %>% filter(week_commencing > max(tv$week_commencing))
forecast_week <-
  cbind(future_dates) %>%
  data.frame(viewers =  predict(model_week, future_dates))



```

```{r tv_add_group_trends, echo=FALSE}

tv_basic_graph +
  geom_smooth(
    method = "lm",
    colour = "black",
    linetype = "dashed",
    fullrange = TRUE,
    se = FALSE
  ) +
  geom_smooth(
    data = tv %>% filter(year < 2020),
    method = "lm",
    colour = "blue",
    linetype = "dashed",
    fullrange = TRUE,
    se = FALSE
  ) +
   geom_line(
    data = forecast_year,
    size = 1.35,
    colour = "red",
    #linetype = "dashed",
    fullrange = TRUE
  )+
  geom_line(
    data = forecast_qtr,
    size = 1.00,
    method = "lm",
    colour = "green",
    #linetype = "dashed",
    fullrange = TRUE
  ) +
    geom_line(
    data = forecast_week,
    size = 1.00,
    method = "lm",
    colour = "purple",
    #linetype = "dashed",
    fullrange = TRUE
  ) 



```
<br>

One way to artificially create the seasonal trend is to add an x^3^ term to the year based model. This would take the form `viewers ~ year + poly(week,3)` and gives the desired seasonal trend. 

A final step would be to include some dummy data to show that Covid is an inflated period: here the data is the Google mobility trends where values during the Covid period are negative, to decrease traffic, and outside of the Covid period they're zero. This would be included in the model in the form `viewers ~ year + poly(week,3) + covid` and is plotted on the graph in red.

This shows the seasonal trend as desired, the gradual yearly trend, and understands that the rise from Covid is not an indicator of future viewer numbers. 

However, using the linear model in this way relied on a visual interpretation of the trend, particularly the seasonal one, rather than a statistical look at the data and a forecast model based upon this.

<br>

```{r tv_add_trends, echo=FALSE}

model_year_poly_week <- lm(data = tv, formula = viewers ~ year+ poly(week,3) + covid)
future_dates<- x_dates %>% filter(week_commencing > max(tv$week_commencing)) %>% mutate(covid = 0)
forecast_year_poly_week <-
  cbind(future_dates) %>%
  data.frame(viewers =  predict(model_year_poly_week, future_dates)) #%>%



tv_basic_graph +
  # geom_smooth(
  #   method = "lm",
  #   colour = "black",
  #   linetype = "dashed",
  #   fullrange = TRUE,
  #   se = FALSE
  # ) +
  # geom_smooth(
  #   data = tv %>% filter(year < 2020),
  #   method = "lm",
  #   colour = "blue",
  #   linetype = "dashed",
  #   fullrange = TRUE,
  #   se = FALSE
  # ) +
  geom_line(
    data = forecast_year_poly_week,
    size = 1.25,
    method = "lm",
    colour = "red",
    fullrange = TRUE
  ) 



```

<br>

```{r tv_forecast, echo = FALSE}
forecast_year_poly_week %>% 
  group_by(year, quarter) %>% 
  summarise(weekly_viewers = comma(signif(mean(viewers),2))) %>% 
  filter(paste0(year,quarter)>'20223' ) %>% 
  kbl(booktabs = T, caption = "Forecast wiewers numbers for England local News",
      col.names = c("year", "quarter", " average weekly viewers"),
    escape = F) %>%
  kable_styling(bootstrap_options =c("striped", "scale_down","hover"))

```

<br>
<br>
<br> 

## ARIMA Modelling

















